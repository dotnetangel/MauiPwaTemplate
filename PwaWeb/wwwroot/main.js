
// main.js: VAPID + WebAuthn integration (client)

async function getVapidPublicKey(){ const resp = await fetch('/api/registerpush/vapidPublicKey'); const data = await resp.json(); return data.key; }
function urlBase64ToUint8Array(base64String){ const padding = '='.repeat((4 - (base64String.length % 4)) % 4); const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/'); const rawData = atob(base64); const outputArray = new Uint8Array(rawData.length); for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i); return outputArray; }
async function registerServiceWorker(){ if('serviceWorker' in navigator) return await navigator.serviceWorker.register('/service-worker.js'); throw 'No service worker support'; }
async function subscribeForPush(reg, vapidPublicKey){ return await reg.pushManager.subscribe({ userVisibleOnly:true, applicationServerKey: urlBase64ToUint8Array(vapidPublicKey) }); }
async function sendSubscriptionToServer(sub){ await fetch('/api/registerpush',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(sub)}); }

document.getElementById('registerBtn').addEventListener('click', async ()=>{ try{ const reg = await registerServiceWorker(); const vapidKey = await getVapidPublicKey(); const sub = await subscribeForPush(reg, vapidKey); await sendSubscriptionToServer(sub); document.getElementById('status').textContent='Status: Push subscription active'; }catch(e){ console.error(e); } });

document.getElementById('sendTestBtn').addEventListener('click', async ()=>{ await fetch('/api/webpush/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:'Test',body:'Hello from server'})}); });

// WebAuthn
function bufferToBase64Url(buffer){ const bytes = new Uint8Array(buffer); let str = ''; for (let i = 0; i < bytes.byteLength; i++) str += String.fromCharCode(bytes[i]); return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function base64UrlToBuffer(base64url){ const padding = '='.repeat((4 - (base64url.length % 4)) % 4); const base64 = (base64url + padding).replace(/-/g,'+').replace(/_/g,'/'); const raw = atob(base64); const buf = new ArrayBuffer(raw.length); const arr = new Uint8Array(buf); for (let i = 0; i < raw.length; i++) arr[i] = raw.charCodeAt(i); return buf; }

async function registerPasskey(){ const username = document.getElementById('username').value; const displayName = document.getElementById('displayName').value; const resp = await fetch('/api/fido/register/options', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,displayName})}); const options = await resp.json(); options.publicKey.challenge = base64UrlToBuffer(options.publicKey.challenge); options.publicKey.user.id = base64UrlToBuffer(options.publicKey.user.id); if(options.publicKey.excludeCredentials) options.publicKey.excludeCredentials = options.publicKey.excludeCredentials.map(c=>({...c,id:base64UrlToBuffer(c.id)})); const attestation = await navigator.credentials.create(options.publicKey); const attResp = { id:attestation.id, rawId:bufferToBase64Url(attestation.rawId), response:{ clientDataJSON:bufferToBase64Url(attestation.response.clientDataJSON), attestationObject:bufferToBase64Url(attestation.response.attestationObject) } }; await fetch('/api/fido/register/complete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({Attestation:attResp, Options:options})}); console.log('Passkey registered'); }

async function loginPasskey(){ const username = document.getElementById('loginUser').value; const resp = await fetch('/api/fido/login/options',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username})}); const options = await resp.json(); options.publicKey.challenge = base64UrlToBuffer(options.publicKey.challenge); if(options.publicKey.allowCredentials) options.publicKey.allowCredentials = options.publicKey.allowCredentials.map(c=>({...c,id:base64UrlToBuffer(c.id)})); const assertion = await navigator.credentials.get(options.publicKey); const assertionResp = { id:assertion.id, rawId:bufferToBase64Url(assertion.rawId), response:{ clientDataJSON:bufferToBase64Url(assertion.response.clientDataJSON), authenticatorData:bufferToBase64Url(assertion.response.authenticatorData), signature:bufferToBase64Url(assertion.response.signature), userHandle: assertion.response.userHandle ? bufferToBase64Url(assertion.response.userHandle) : null } }; const r = await fetch('/api/fido/login/complete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({Assertion:assertionResp, Options:options, Username:username})}); const j = await r.json(); console.log('Login', j); }

document.getElementById('registerPasskey').addEventListener('click', registerPasskey);
document.getElementById('loginPasskey').addEventListener('click', loginPasskey);
